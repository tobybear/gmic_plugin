/*
 #
 #  File        : gmic_utils.h
 #
 #  Description : various helper functions to deal with the handling of G'MIC filters
 #
 #  Copyright   : Tobias Fleischer / reduxFX Productions (http://www.reduxfx.com)
 #
 #  Licenses        : This file is 'dual-licensed', you have to choose one
 #                    of the two licenses below to apply.
 #
 #                    CeCILL-C
 #                    The CeCILL-C license is close to the GNU LGPL.
 #                    ( http://www.cecill.info/licences/Licence_CeCILL-C_V1-en.html )
 #
 #                or  CeCILL v2.0
 #                    The CeCILL license is compatible with the GNU GPL.
 #                    ( http://www.cecill.info/licences/Licence_CeCILL_V2-en.html )
 #
 #  This software is governed either by the CeCILL or the CeCILL-C license
 #  under French law and abiding by the rules of distribution of free software.
 #  You can  use, modify and or redistribute the software under the terms of
 #  the CeCILL or CeCILL-C licenses as circulated by CEA, CNRS and INRIA
 #  at the following URL: "http://www.cecill.info".
 #
 #  As a counterpart to the access to the source code and  rights to copy,
 #  modify and redistribute granted by the license, users are provided only
 #  with a limited warranty  and the software's author,  the holder of the
 #  economic rights,  and the successive licensors  have only  limited
 #  liability.
 #
 #  In this respect, the user's attention is drawn to the risks associated
 #  with loading,  using,  modifying and/or developing or reproducing the
 #  software by the user in light of its specific status of free software,
 #  that may mean  that it is complicated to manipulate,  and  that  also
 #  therefore means  that it is reserved for developers  and  experienced
 #  professionals having in-depth computer knowledge. Users are therefore
 #  encouraged to load and test the software's suitability as regards their
 #  requirements in conditions enabling the security of their systems and/or
 #  data to be ensured and,  more generally, to use and operate it in the
 #  same conditions as regards security.
 #
 #  The fact that you are presently reading this means that you have had
 #  knowledge of the CeCILL and CeCILL-C licenses and that you accept its terms.
 #
*/
#pragma once

#include <string>
#include <vector>
#include <map>
#include "RFX_StringUtils.h"

#ifndef AE_PLUGIN
#include "rapidjson/document.h"
#include "rapidjson/stringbuffer.h"
using namespace rapidjson;
#endif

using namespace std;
using namespace reduxfx;

struct gmicParameter {
	string name;
	string minValue;
	string maxValue;
	string defaultValue;
	string text;
	string paramType;
};

struct gmicFilter {
	string category;
	string name;
	string uniqueId;
	string command;
	string preview_command;
	string notes;
	bool multiLayer;
	vector<gmicParameter> param;
};

static string serializeFilter(const gmicFilter& f) {
	string s;
	string sep = "\a";
	s = f.category + sep + f.name + sep + f.uniqueId + sep + f.command + sep + f.preview_command + sep + f.notes + sep;
	if (f.multiLayer) s += "1"; else s += "0";
	s += sep + intToString((int)f.param.size()) + sep;
	for (int i = 0; i < (int)f.param.size(); i++) {
		s += f.param[i].name + sep;
		s += f.param[i].minValue + sep;
		s += f.param[i].maxValue + sep;
		s += f.param[i].defaultValue + sep;
		s += f.param[i].text + sep;
		s += f.param[i].paramType + sep;
	}
	s = strReplace(s, "$", "");
	s = strReplace(s, "\a", "$");
	s = strReplace(s, "\r\n", "\\n");
	s = strReplace(s, "\r", "\\n");
	s = strReplace(s, "\n", "\\n");
	return s;
}

static gmicFilter deserializeFilter(const string s) {
	string s2 = strReplace(s, "\\n", "\n");
	vector<string> ss;
	gmicFilter f;
	f.name = "";
	strSplit(s2, '$', ss, true);
	if (ss.size() < 8) return f;
	f.category = ss[0];
	f.name = ss[1];
	f.uniqueId = ss[2];
	f.command = ss[3];
	f.preview_command = ss[4];
	f.notes = ss[5];
	f.multiLayer = atoi(ss[6].c_str()) > 0;
	int numParams = atoi(ss[7].c_str());
	int cnt = 8;
	for (int i = 0; i < numParams; i++) {
		gmicParameter p;
		p.name = ss[cnt++];
		p.minValue = ss[cnt++];
		p.maxValue = ss[cnt++];
		p.defaultValue = ss[cnt++];
		p.text = ss[cnt++];
		p.paramType = ss[cnt++];
		f.param.push_back(p);
	}
	return f;
}

static string get_gmic_rc_path() {
	string path;
	const char* _path_rc = NULL;
	if (!_path_rc) _path_rc = getenv("GMIC_PATH");
	if (!_path_rc) _path_rc = getenv("GMIC_GIMP_PATH");
	if (!_path_rc) _path_rc = getenv("XDG_CONFIG_HOME");
	if (!_path_rc) {
#ifndef _WIN32
		_path_rc = getenv("HOME");
		if (_path_rc) 
			path = string(_path_rc) + "/.config/gmic/";
		}
#else
		_path_rc = getenv("APPDATA");
#endif
	}
	if (!_path_rc) _path_rc = getenv("TMP");
	if (!_path_rc) _path_rc = getenv("TEMP");
	if (!_path_rc) _path_rc = getenv("TMPDIR");
	if (path == "") path = string(_path_rc) + "/gmic/";
	return path;
}

static string getUniqueId(string name) {
	string uniqueid = "";
	for (unsigned int i = 0; i < name.size(); i++) {
		if ((name[i] >= 'a' && name[i] <= 'z')
			|| (name[i] >= 'A' && name[i] <= 'Z')
			|| (name[i] >= '0' && name[i] <= '9'))
			uniqueid += name[i];
	}
	// The recommended format is the reverse domain name format of the developer, for example "uk.co.thefoundry", followed by the developer's unique name for the plug-in. e.g. "uk.co.thefoundry.F_Kronos".
	return "eu.gmic." + uniqueid;
}

#ifndef AE_PLUGIN
int applySelect(const vector<string>& selectList, vector<gmicFilter>& filters) {
	if (selectList.size() == 0) return 1;
	vector<gmicFilter> filters2;
	for (int j = 0; j < (int)filters.size(); j++) {
		string sf = filters[j].category + "/" + filters[j].name;

		for (int i = 0; i < (int)selectList.size(); i++) {
			string sl = strTrim(selectList[i], " \t\r\n");
			if (sl == "" || sl[0] == '#' || sl[0] == ';') continue; // skip blank lines and comments
			int pos = (int)sl.find("#");
			if (pos >= 0) {
				sl = sl.substr(0, pos); // trim comments at end of line
			}
			sl = strTrim(sl);

			bool inv = false;
			if (sl[0] == '+') sl = sl.substr(1);
			if (sl[0] == '-') {
				sl = sl.substr(1);
				inv = true;
			}
			if ((int)sf.find(sl) >= 0) {
				if (inv) break;
				filters2.push_back(filters[j]);
				break;
			}
		}
	}
	filters = filters2;
	return 0;
}

int parseFilters(const string& content, vector<gmicFilter>& filters) {
	// LOG << "parse filters start";
	Document d;
	d.Parse(content.c_str());
	string fsmax;

	map<string, gmicFilter> filterMap;

	Value& v = d["categories"];
	for (auto it = v.Begin(); it != v.End(); it++) {
		Value& v2 = (*it)["name"];
		string cat = v2.GetString();
		if ((int)strLowercase(cat).find("about") >= 0) continue; // skip "about" filter category
		else if ((int)strLowercase(cat).find("sequences") >= 0) continue; // skip "sequences" filter category

		Value& v2f = (*it)["filters"];
		for (auto it2 = v2f.Begin(); it2 != v2f.End(); it2++) {
			gmicFilter f;
			f.category = cat;

			Value& v3l = (*it2)["lang"];
			string lang = v3l.GetString();
			if (lang != "en") continue; // we only look for filters in english, comment out this line to get filters in all languages

			Value& v3 = (*it2)["name"];
			f.name = v3.GetString();
			if ((int)strLowercase(f.name).find("[interactive]") >= 0) continue; // skip interactive filters
			else if ((int)strLowercase(f.name).find("[animated]") >= 0) continue; // skip animated filters
			else if ((int)strLowercase(f.name).find("[multichannel]") >= 0) continue; // skip multichannel filters (todo: check if still needed)
			else if ((int)strLowercase(f.name).find("[full image]") >= 0) continue; // skip full image filters (todo: check if still needed)
			else if ((int)strLowercase(f.name).find("about") >= 0) continue; // skip about filters
			
			else if ((int)strLowercase(f.name).find("transfer color") >= 0) continue; // buggy filter description? (todo: check what is causing the error)
			
			Value& v3c = (*it2)["command"];
			f.command = v3c.GetString();
			if ((int)strLowercase(f.command).find("interactive") >= 0) continue; // skip interactive filters
			
			if (it2->HasMember("command_preview")) {
				v3c = (*it2)["command_preview"];
				f.preview_command = v3c.GetString();
			} else {
				f.preview_command = f.command;
			}
			f.multiLayer = false;

			Value& v3p = (*it2)["parameters"];

			for (auto it3 = v3p.Begin(); it3 != v3p.End(); it3++) {
				gmicParameter fp;
				if (it3->HasMember("default")) fp.defaultValue = (*it3)["default"].GetString();
				if (it3->HasMember("min")) fp.minValue = (*it3)["min"].GetString();
				if (it3->HasMember("max")) fp.maxValue = (*it3)["max"].GetString();
				// if (it3->HasMember("pos")) index = (*it3)["pos"].GetString();
				if (it3->HasMember("text")) {
					fp.text = (*it3)["text"].GetString();
					if ((int)fp.text.find("<img") >= 0) fp.text = "";
				}
				if (it3->HasMember("value")) fp.text = (*it3)["value"].GetString();
				if (it3->HasMember("position")) {
					fp.defaultValue = (*it3)["position"].GetString();
					fp.defaultValue = strReplace(fp.defaultValue, ",", "|");
				}
				if (it3->HasMember("type")) fp.paramType = (*it3)["type"].GetString();
				if (it3->HasMember("name")) fp.name = strLowercase((*it3)["name"].GetString());
				if (strLowercase(fp.paramType) == "note" && (int)(strLowercase(fp.text).find(" layers")) >= 0) f.multiLayer = true;
				if ((int)(strLowercase(fp.name).find("layer")) >= 0) f.multiLayer = true;
				if (it3->HasMember("choices")) {
					string choices;
					Value& cf = (*it3)["choices"];
					for (auto itc = cf.MemberBegin(); itc != cf.MemberEnd(); itc++) {
						choices += itc->value.GetString();
						choices += "|";
					}
					if (choices != "") {
						choices = choices.substr(0, choices.size() - 1);
						fp.text = choices;
					}
				}

				string n;
				for (int i = 0; i < (int)fp.name.size(); i++) {
					if (fp.name[i] >= 32 && fp.name[i] <= 126) n += fp.name[i];
				}
				n = strReplace(n, " & ", " And ");
				f.param.push_back(fp);
			}
			f.uniqueId = getUniqueId(f.name);
			f.category = cat;
			filters.push_back(f);
			/*
			if (selectList.size() == 0) {
				f.category = cat;
				filters.push_back(f);
			} else {
				if (filterMap.find(f.name) != filterMap.end()) {
					f.name += " (Alt.)";
				}
				filterMap[f.name] = f;
			}
			*/
			// fsmax += serializeFilter(f) + "\n";
		}
	}
	// LOG << "parse filters: " << filters.size();
	return (int)filters.size();	
}
#endif

// this is a the generic G'MIC plugin's parameter code, followed by a static array of "dummy" data that goes unused in the generic G'MIC plugin, but gets patched over with the actual code to execute for specific filter builds
extern "C" const char* GMIC_CODE = "G'MIC$G'MIC Generic Plugin$eu.gmic.gmic$$$$1$8$Parameter A$0$1$0$$float$Parameter B$0$1$0$$float$Parameter C$0$1$0$$float$Parameter D$0$1$0$$float$Parameter E$0$1$0$$float$Parameter F$0$1$0$$float$Parameter G$0$1$0$$float$Parameter H$0$1$0$$float$$$$$" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"############################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################" \
"##################";

